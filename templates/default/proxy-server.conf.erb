<%

case @authmode
when "keystone"
  auth_middleware="authtoken keystone"
when "swauth"
  auth_middleware="swauth"
end

account_management=false
if node[:roles].include?("swift-management-server") and node[:swift][:authmode] == "swauth" then
  account_management="true"
end
-%>
# This file is managed by chef.  Do not edit it.
# Please check the swift conf manpages for more details. 
#
# Cluster info:
#   Auth mode: <%= node[:swift][:authmode] %>
#   Management server: <%= node[:roles].include?("swift-management-server") %>
#   Account management enabled: <%= account_management %>
#   Auth pipeline: <%= pipeline %>

[DEFAULT]
workers = <%= [ node[:cpu][:total] - 1, 1 ].max %>
bind_ip = <%= @bind_host %>
bind_port = <%= @bind_port %>
swift_dir = /etc/swift
user = swift

[pipeline:main]
pipeline = <% if @use_informant %>informant<% end %> catch_errors healthcheck cache ratelimit <%= auth_middleware %> proxy-logging proxy-server

[app:proxy-server]
use = egg:swift#proxy
set log_facility = LOG_LOCAL0
node_timeout = 60
client_timeout = 60
conn_timeout = 3.5
allow_account_management = <%= account_management %>
<% if @authmode == "keystone" -%>
account_autocreate = true
<% end %>

<% if @use_informant %>
[filter:informant]
use = egg:informant#informant
statsd_host = <%= @statsd_host %>
statsd_port = <%= @statsd_port %>
<% end %>

[filter:swauth]
use = egg:swauth#swauth
set log_facility = LOG_LOCAL0
reseller_prefix = AUTH
auth_prefix = /auth/
default_swift_cluster = local#<%= @cluster_endpoint %>#http://127.0.0.1/v1
<% if account_management -%>
super_admin_key = <%= node[:swift][:authkey] %>
<% end -%>

[filter:healthcheck]
use = egg:swift#healthcheck

[filter:cache]
use = egg:swift#memcache

[filter:ratelimit]
use = egg:swift#ratelimit

[filter:proxy-logging]
use = egg:swift#proxy_logging

[filter:keystone]
paste.filter_factory = keystone.middleware.swift_auth:filter_factory
operator_roles = Member,admin

[filter:authtoken]
paste.filter_factory = keystone.middleware.auth_token:filter_factory
auth_host = <%= @keystone_api_ipaddress %>
auth_port = <%= @keystone_admin_port %>
auth_protocol = http
auth_uri = http://<%= @keystone_api_ipaddress %>:<%= @keystone_admin_port %>/
admin_tenant_name = <%= @service_tenant_name %>
admin_user = <%= @service_user %>
admin_password = <%= @service_pass %>
delay_auth_decision = 1
signing_dir = /tmp/keystone-signing-swift

